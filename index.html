<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Custom Map with Interactive Countries & Points</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Turf.js for spatial calculations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    .marker {
      background-color: #5a6bff;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
    }
    .marker:hover {
      background-color: #ff5722 !important;
    }
    .mapboxgl-popup-content {
      padding: 15px;
      border-radius: 8px;
      background: #fff;
      color: #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border: 1px solid #eee;
      transition: all 0.3s ease;
    }
    .mapboxgl-popup-content h3 {
      margin: 0 0 5px;
      font-size: 18px;
      color: #0077ff;
    }
    .mapboxgl-popup-content p {
      margin: 0;
      font-size: 14px;
    }
    #search-container {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(4px);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
      transition: background 0.3s ease;
    }
    #search-box {
      width: 300px;
      padding: 10px;
      font-size: 16px;
      border: none;
      outline: none;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s ease;
    }
    #search-box:focus {
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    #side-popup {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 280px;
      background: linear-gradient(135deg, #ffffff, #e6f7ff);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
      display: none;
      z-index: 11;
      border: 1px solid #cce7ff;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #side-popup h3 {
      margin: 0 0 10px;
      color: #0077ff;
      font-size: 22px;
      font-weight: 600;
    }
    #side-popup a {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 16px;
      background: #0077ff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.3s;
    }
    #side-popup a:hover {
      background: #005bb5;
    }
  </style>
</head>
<body>
  <div id="search-container">
    <input type="text" id="search-box" placeholder="🔍 Search locations...">
  </div>
  <div id="side-popup"></div>
  <div id="map"></div>

  <script>
    // 1) read optional "?city=Name" query-string
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const cityParam = getQueryParam('city')?.toLowerCase();

    // helper: country-code → emoji
    function isoToEmoji(isoCode) {
      return isoCode.toUpperCase()
        .split('')
        .map(c => String.fromCodePoint(127397 + c.charCodeAt()))
        .join('');
    }

    function updateCountrySidePopup(feature) {
      const countryName = feature.properties.ADMIN || feature.properties.NAME || "Unknown";
      const iso = (feature.properties.iso_3166_1 || "").toUpperCase();
      const emoji = iso ? isoToEmoji(iso) : "";
      const content = `
        <div style="display:flex; align-items:center;">
          <span style="font-size:32px; margin-right:10px;">${emoji}</span>
          <span style="font-size:20px; font-weight:600; color:#0077ff;">${countryName}</span>
        </div>`;
      const sp = document.getElementById('side-popup');
      sp.innerHTML = content;
      sp.style.display = "block";
    }

    function updateSidePopup(data) {
      const sp = document.getElementById('side-popup');
      if (!data) {
        sp.style.display = "none";
        return;
      }
      let html = '';
      if (!data.popup) {
        html += `<h3>${data.name}</h3>`;
      }
      if (data.popup) {
        html += `<div>${data.popup}</div>`;
      }
      if (data.link) {
        html += `<a href="${data.link}" target="_blank">Explore →</a>`;
      }
      sp.innerHTML = html;
      sp.style.display = "block";
    }

    function throttle(fn, limit) {
      let last, timer;
      return function(...args) {
        const now = Date.now();
        if (!last || now - last >= limit) {
          fn.apply(this, args);
          last = now;
        } else {
          clearTimeout(timer);
          timer = setTimeout(() => {
            fn.apply(this, args);
            last = Date.now();
          }, limit - (now - last));
        }
      };
    }

    mapboxgl.accessToken = 'pk.eyJ1Ijoic2lja281IiwiYSI6ImNtNXNvNDlqcDBvcngyanE2OW9jYjEwYXMifQ.jCPdU-0lcRGjtDpaxoICsw';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/sicko5/cm6k1juil010301qm2krq7o84',
      center: [-30, 40],
      zoom: 2
    });

    const mapMarkers = [];
    const cityMarkers = [];
    let lockedCountry = null;
    let lockedCity = null;
    let countryLocked = false;

    function updateMarkerVisibility() {
      const z = map.getZoom();
      mapMarkers.forEach(m => {
        const el = m.getElement();
        const min = parseFloat(el.dataset.zoomMin);
        const max = parseFloat(el.dataset.zoomMax);
        el.style.display = (z >= min && z <= max) ? 'block' : 'none';
      });
    }

    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vR-zg6jI431F1q5MKA927NjE5yZvZPLngBoyd0wmV93vyMSPOYsJMdSXJ1oWDkBZbiesDk6AlkUzR3M/pub?gid=0&single=true&output=csv", {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(d => {
          if (!d.lat || !d.lng) return;
          const el = document.createElement('div');
          el.className = 'marker';
          el.dataset.locked = 'false';
          if (d.color) el.style.backgroundColor = d.color;
          el.dataset.name = (d.name||'').toLowerCase();
          el.dataset.zoomMin = (d.isCity?.toLowerCase()==='true' ? (d.zoomMin||0) : (d.zoomMin||12));
          el.dataset.zoomMax = d.zoomMax||20;

          const popupHTML = `
            ${d.popup ? `<div>${d.popup}</div>` : `<h3>${d.name}</h3>`}
            ${d.link ? `<p style="margin-top:10px;"><a href="${d.link}" target="_blank" style="padding:8px 14px;background:#0077ff;color:#fff;border-radius:6px;text-decoration:none;font-weight:bold;">Explore →</a></p>` : ''}
          `;
          const popup = new mapboxgl.Popup({ offset:25, closeOnClick:false, closeButton:false })
            .setHTML(popupHTML);

          const marker = new mapboxgl.Marker(el)
            .setLngLat([parseFloat(d.lng), parseFloat(d.lat)])
            .addTo(map);
          marker.markerData = d;
          mapMarkers.push(marker);
          if (d.isCity?.toLowerCase()==='true') cityMarkers.push(marker);

          // hover / click handlers...
          el.addEventListener('mouseenter', () => {
            if (el.dataset.locked==='true') return;
            countryLocked = false;
            popup.setLngLat([parseFloat(d.lng), parseFloat(d.lat)]).addTo(map);
          });
          el.addEventListener('mouseleave', () => {
            if (el.dataset.locked==='true') return;
            setTimeout(() => { if (el.dataset.locked==='false') popup.remove(); }, 100);
          });
          el.addEventListener('click', e => {
            e.stopPropagation();
            lockedCountry = null;
            map.setFilter('country-fills-highlight', ['==','iso_3166_1','']);
            map.getCanvas().style.cursor = '';
            updateSidePopup(d);
            popup.remove();
            lockedCity = d.isCity?.toLowerCase()==='true' ? d : null;
            map.flyTo({
              center: [parseFloat(d.lng), parseFloat(d.lat)],
              zoom: 14,
              speed: 1.5
            });
          });
        });

        // 2) after we've added all markers, adjust visibility & optionally fly to cityParam
        updateMarkerVisibility();

        if (cityParam) {
          const target = mapMarkers.find(m => m.markerData.name.toLowerCase() === cityParam);
          if (target) {
            const td = target.markerData;
            map.flyTo({
              center: [parseFloat(td.lng), parseFloat(td.lat)],
              zoom: 14,
              speed: 1.5
            });
            updateSidePopup(td);
          }
        }
      }
    });

    map.on('zoom', updateMarkerVisibility);

    document.getElementById('search-box').addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      mapMarkers.forEach(m => {
        const el = m.getElement();
        el.style.display = !term || el.dataset.name.includes(term) ? 'block' : 'none';
      });
    });

    document.getElementById('search-box').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const term = e.target.value.trim().toLowerCase();
        let found = mapMarkers.find(m => m.markerData.name.toLowerCase().includes(term));
        if (found) {
          const d = found.markerData;
          lockedCountry = null;
          map.flyTo({ center:[parseFloat(d.lng), parseFloat(d.lat)], zoom:14, speed:1.5 });
          updateSidePopup(d);
        } else {
          // fallback country search...
        }
      }
    });

    map.on('moveend', () => {
      const z = map.getZoom();
      if (lockedCountry) {
        if (z < 3.5) { lockedCountry = null; updateSidePopup(null); }
        else updateCountrySidePopup(lockedCountry);
        return;
      }
      if (z < 12) {
        updateSidePopup(null);
        lockedCity = null;
        return;
      }
      if (lockedCity) {
        updateSidePopup(lockedCity);
        return;
      }
      // auto-center city popup...
      const bounds = map.getBounds();
      const centerPt = { x: map.getCanvas().width/2, y: map.getCanvas().height/2 };
      let closest = null, minDist = Infinity;
      cityMarkers.forEach(m => {
        if (!bounds.contains(m.getLngLat())) return;
        const p = map.project(m.getLngLat());
        const d2 = (p.x-centerPt.x)**2 + (p.y-centerPt.y)**2;
        if (d2 < minDist) { minDist = d2; closest = m; }
      });
      if (closest) updateSidePopup(closest.markerData);
      else updateSidePopup(null);
    });

    map.on('load', () => {
      map.addSource('country-boundaries', {
        type: 'vector',
        url: 'mapbox://mapbox.country-boundaries-v1'
      });
      map.addLayer({
        id: 'country-fills',
        type: 'fill',
        source: 'country-boundaries',
        'source-layer': 'country_boundaries',
        paint: { 'fill-opacity': 0 }
      });
      map.addLayer({
        id: 'country-fills-highlight',
        type: 'fill',
        source: 'country-boundaries',
        'source-layer': 'country_boundaries',
        paint: { 'fill-color': 'rgba(200,200,200,0.3)' },
        filter: ['==','iso_3166_1','']
      });
      map.addLayer({
        id: 'country-borders',
        type: 'line',
        source: 'country-boundaries',
        'source-layer': 'country_boundaries',
        paint: { 'line-color': '#aaa', 'line-width': 1 }
      });

      const northAm = ['USA','CAN','MEX'];
      map.on('mousemove', throttle(e => {
        if (map.getZoom()>=12 || lockedCountry) return;
        const feats = map.queryRenderedFeatures(e.point, { layers:['country-fills'] });
        if (!feats.length) {
          map.getCanvas().style.cursor='';
          map.setFilter('country-fills-highlight',['==','iso_3166_1','']);
          updateSidePopup(null);
          return;
        }
        const f = feats[0], iso = f.properties.iso_3166_1;
        const thresh = northAm.includes(iso)?3:4;
        if (map.getZoom()>thresh) {
          map.getCanvas().style.cursor='';
          map.setFilter('country-fills-highlight',['==','iso_3166_1','']);
          updateSidePopup(null);
        } else {
          map.getCanvas().style.cursor='pointer';
          map.setFilter('country-fills-highlight',['==','iso_3166_1',iso]);
          updateCountrySidePopup(f);
        }
      }, 20));

      map.on('click','country-fills', e => {
        const f = e.features[0];
        let bbox;
        if (f.properties.iso_3166_1==='CAN') {
          let combined, found=false;
          f.geometry.coordinates.forEach(poly => {
            const feat={type:'Feature',geometry:{type:'Polygon',coordinates:poly}};
            const cent = turf.centroid(feat);
            if (cent.geometry.coordinates[1]<60) {
              found=true;
              const bb = turf.bbox(feat);
              combined = combined
                ? [
                    Math.min(combined[0],bb[0]),
                    Math.min(combined[1],bb[1]),
                    Math.max(combined[2],bb[2]),
                    Math.max(combined[3],bb[3])
                  ]
                : bb;
            }
          });
          bbox = found?combined:turf.bbox(f);
        } else {
          let tgt = f;
          if (f.geometry.type==='MultiPolygon') {
            let maxA=0;
            f.geometry.coordinates.forEach(poly => {
              const feat={type:'Feature',geometry:{type:'Polygon',coordinates:poly}};
              const a = turf.area(feat);
              if (a>maxA){maxA=a; tgt=feat;}
            });
          }
          bbox = turf.bbox(tgt);
        }
        map.fitBounds(bbox, { padding:20, duration:500 });
        map.setFilter('country-fills-highlight',['==','iso_3166_1','']);
        lockedCountry = f;
        lockedCity = null;
        updateCountrySidePopup(f);
      });
    });

    map.on('click', () => { countryLocked = false; });

    // ensure country highlight sits below symbols
    const layers = map.getStyle().layers;
    for (let l of layers) {
      if (l.type==='symbol') {
        map.moveLayer('country-fills-highlight', l.id);
        break;
      }
    }
  </script>
</body>
</html>
