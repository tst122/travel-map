<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Interactive Map – NA & Europe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Turf.js for spatial calculations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f0f2f5;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    /* Marker style */
    .marker {
      background-color: #5a6bff;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background-color 0.2s ease;
    }
    .marker:hover {
      background-color: #ff5722;
    }
    /* Popup content style */
    .mapboxgl-popup-content {
      padding: 8px;
      border-radius: 6px;
      background: #fff;
      color: #333;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border: 1px solid #ddd;
      transition: opacity 0.2s ease;
    }
    .mapboxgl-popup-content h3 {
      margin: 0 0 4px;
      font-size: 16px;
      color: #0077ff;
    }
    .mapboxgl-popup-content p {
      margin: 0;
      font-size: 14px;
    }
    /* Search container style */
    #search-container {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(4px);
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #ccc;
    }
    #search-box {
      width: 280px;
      padding: 8px;
      font-size: 14px;
      border: none;
      outline: none;
      background: #f9f9f9;
      border-radius: 6px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    /* Side popup style */
    #side-popup {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 250px;
      background: #fff;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: none;
      z-index: 11;
      border: 1px solid #ccc;
    }
    #side-popup h3 {
      margin: 0 0 4px;
      font-size: 18px;
      color: #0077ff;
    }
    #side-popup a {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 10px;
      background: #0077ff;
      color: #fff;
      border-radius: 4px;
      text-decoration: none;
      font-size: 14px;
    }
    #side-popup a:hover { background: #005bb5; }
  </style>
</head>
<body>
  <div id="search-container">
    <input type="text" id="search-box" placeholder="Search locations...">
  </div>
  <div id="side-popup"></div>
  <div id="map"></div>
  <script>
    // Throttle helper function (limit to 10ms)
    function throttle(func, limit) {
      let lastFunc, lastRan;
      return function() {
        const context = this, args = arguments;
        if (!lastRan) {
          func.apply(context, args);
          lastRan = Date.now();
        } else {
          clearTimeout(lastFunc);
          lastFunc = setTimeout(function() {
            if ((Date.now() - lastRan) >= limit) {
              func.apply(context, args);
              lastRan = Date.now();
            }
          }, limit - (Date.now() - lastRan));
        }
      }
    }
    
    // Initialize the map so that North America and Europe are visible.
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2lja281IiwiYSI6ImNtNXNvNDlqcDBvcngyanE2OW9jYjEwYXMifQ.jCPdU-0lcRGjtDpaxoICsw';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/sicko5/cm6k1juil010301qm2krq7o84',
      center: [-20, 55],
      zoom: 3.5
    });
    
    const mapMarkers = [];
    const cityMarkers = [];
    let lockedCity = null;
    let countryLocked = false; // When true, country hover effect is disabled.
    
    // Update side popup based on marker data.
    function updateSidePopup(data) {
      const sp = document.getElementById('side-popup');
      if (data) {
        let html = "";
        if (!data.popup) { html += `<h3>${data.name}</h3>`; }
        html += data.popup ? `<div>${data.popup}</div>` : "";
        html += data.link ? `<a href="${data.link}" target="_blank">Explore →</a>` : "";
        sp.innerHTML = html;
        sp.style.display = "block";
      } else {
        sp.style.display = "none";
      }
    }
    
    // Update marker visibility.
    function updateMarkerVisibility() {
      const z = map.getZoom();
      mapMarkers.forEach(marker => {
        const el = marker.getElement();
        const min = parseFloat(el.dataset.zoomMin);
        const max = parseFloat(el.dataset.zoomMax);
        el.style.display = (z >= min && z <= max) ? "block" : "none";
      });
    }
    
    // Load markers from CSV.
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vR-zg6jI431F1q5MKA927NjE5yZvZPLngBoyd0wmV93vyMSPOYsJMdSXJ1oWDkBZbiesDk6AlkUzR3M/pub?gid=0&single=true&output=csv", {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(data => {
          if (!data.lat || !data.lng) return;
          const el = document.createElement("div");
          el.className = "marker";
          const popupHTML = data.popup ? `<div>${data.popup}</div>` : `<h3>${data.name}</h3>`;
          const linkHTML = data.link ? `<p style="margin-top:6px;"><a href="${data.link}" target="_blank">Explore →</a></p>` : "";
          const popup = new mapboxgl.Popup({ offset: 25, closeOnClick: false, closeButton: false })
                          .setHTML(popupHTML + linkHTML);
          const marker = new mapboxgl.Marker(el)
                          .setLngLat([parseFloat(data.lng), parseFloat(data.lat)])
                          .addTo(map);
          marker.markerData = data;
          if (data.isCity && data.isCity.toLowerCase() === "true") {
            cityMarkers.push(marker);
          }
          // Marker hover: show popup immediately.
          el.addEventListener("mouseenter", () => {
            countryLocked = false; // Reset country lock
            popup.setLngLat([parseFloat(data.lng), parseFloat(data.lat)]).addTo(map);
          });
          el.addEventListener("mouseleave", () => {
            popup.remove();
          });
          // Marker click: stop propagation, fly to marker, update side popup.
          el.addEventListener("click", (e) => {
            e.stopPropagation();
            countryLocked = false;
            map.flyTo({
              center: [parseFloat(data.lng), parseFloat(data.lat)],
              zoom: 14,
              speed: 2
            });
            lockedCity = (data.isCity && data.isCity.toLowerCase() === "true") ? data : null;
            updateSidePopup(data);
          });
          // Zoom filtering.
          if(data.isCity && data.isCity.toLowerCase() === "true") {
            el.dataset.zoomMin = data.zoomMin || 0;
          } else {
            el.dataset.zoomMin = data.zoomMin || 12;
          }
          el.dataset.zoomMax = data.zoomMax || 20;
          el.dataset.name = (data.name || "").toLowerCase();
          mapMarkers.push(marker);
        });
        updateMarkerVisibility();
      }
    });
    
    map.on("zoom", updateMarkerVisibility);
    
    document.getElementById("search-box").addEventListener("input", function(e) {
      const term = e.target.value.toLowerCase();
      mapMarkers.forEach(marker => {
        const name = marker.getElement().dataset.name;
        marker.getElement().style.display = (!term || (name && name.includes(term))) ? "block" : "none";
      });
    });
    
    map.on("moveend", () => {
      const z = map.getZoom();
      if(z < 12) { updateSidePopup(null); lockedCity = null; return; }
      if(lockedCity) { updateSidePopup(lockedCity); return; }
      const center = { x: map.getCanvas().width/2, y: map.getCanvas().height/2 };
      let closest = null, minD = Infinity;
      cityMarkers.forEach(marker => {
        const pos = map.project(marker.getLngLat());
        const d = Math.sqrt(Math.pow(pos.x - center.x,2) + Math.pow(pos.y - center.y,2));
        if(d < minD) { minD = d; closest = marker; }
      });
      if(closest && minD < 100) { updateSidePopup(closest.markerData); }
      else { updateSidePopup(null); }
    });
    
    /* Country boundaries via fill layers */
    map.on("load", function() {
      map.addSource("country-boundaries", {
        type: "vector",
        url: "mapbox://mapbox.country-boundaries-v1"
      });
      // Invisible fill layer for interactivity.
      map.addLayer({
        id: "country-fills",
        type: "fill",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "fill-color": "#888888",
          "fill-opacity": 0
        }
      });
      // Highlight layer for hover effect.
      map.addLayer({
        id: "country-fills-highlight",
        type: "fill",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "fill-color": "rgba(200,200,200,0.3)"
        },
        filter: ["==", "iso_3166_1", ""]
      });
      // Border line layer.
      map.addLayer({
        id: "country-borders",
        type: "line",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "line-color": "#aaa",
          "line-width": 1
        }
      });
      
      // List of North American ISO codes.
      const na = ["USA", "CAN", "MEX"];
      
      // Throttled mousemove for country hover highlight.
      map.on("mousemove", throttle(function(e) {
        let threshold = 4; // default for non-NA.
        const feats = map.queryRenderedFeatures(e.point, { layers: ["country-fills"] });
        if(feats.length > 0) {
          const feat = feats[0];
          if(na.includes(feat.properties.iso_3166_1)) { threshold = 3; }
          if(map.getZoom() > threshold || countryLocked) {
            map.getCanvas().style.cursor = "";
            map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
            return;
          }
          map.getCanvas().style.cursor = "pointer";
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", feat.properties.iso_3166_1]);
        }
        else {
          map.getCanvas().style.cursor = "";
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
        }
      }, 10));
      
      // On country click, zoom to its mainland (largest polygon) quickly and lock hover.
      map.on("click", "country-fills", function(e) {
        if(e.features.length > 0) {
          const feat = e.features[0];
          let target = feat;
          if(feat.geometry.type === "MultiPolygon") {
            let maxA = 0;
            feat.geometry.coordinates.forEach(polygon => {
              const poly = { type: "Feature", geometry: { type: "Polygon", coordinates: polygon } };
              const area = turf.area(poly);
              if(area > maxA) { maxA = area; target = poly; }
            });
          }
          const bbox = turf.bbox(target);
          map.fitBounds(bbox, { padding: 20, duration: 300 });
          countryLocked = true;
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
        }
      });
    });
    
    map.on("click", function() { countryLocked = false; });
    
    // Ensure country highlight layer is below symbol layers.
    map.on("styledata", function() {
      const layers = map.getStyle().layers;
      let sym;
      for(let i = 0; i < layers.length; i++) {
        if(layers[i].type === "symbol") { sym = layers[i].id; break; }
      }
      if(sym) { map.moveLayer("country-fills-highlight", sym); }
    });
  </script>
</body>
</html>

