<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Custom Map with Interactive Countries & Points</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Turf.js for spatial calculations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    /* Marker style with hover effect */
    .marker {
      background-color: #5a6bff;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
    }
    .marker:hover {
      background-color: #ff5722;
    }
    /* Popup content style for marker popups */
    .mapboxgl-popup-content {
      padding: 15px;
      border-radius: 8px;
      background: #fff;
      color: #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border: 1px solid #eee;
      transition: all 0.3s ease;
    }
    .mapboxgl-popup-content h3 {
      margin: 0 0 5px;
      font-size: 18px;
      color: #0077ff;
    }
    .mapboxgl-popup-content p {
      margin: 0;
      font-size: 14px;
    }
    /* Search container style with slight transparency and blur */
    #search-container {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(4px);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
      transition: background 0.3s ease;
    }
    #search-box {
      width: 300px;
      padding: 10px;
      font-size: 16px;
      border: none;
      outline: none;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s ease;
    }
    #search-box:focus {
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    /* Side popup style (used for both marker and country hover popups) */
    #side-popup {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 250px;
      background: linear-gradient(145deg, #ffffff, #f9f9f9);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
      display: none;
      z-index: 11;
      border: 1px solid #ccc;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #side-popup h3 {
      margin: 0 0 5px;
      color: #0077ff;
      font-size: 20px;
    }
    #side-popup a {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 14px;
      background: #0077ff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.3s;
    }
    #side-popup a:hover {
      background: #005bb5;
    }
  </style>
</head>
<body>
  <div id="search-container">
    <input type="text" id="search-box" placeholder="🔍 Search locations...">
  </div>
  <!-- Side popup (used for marker and country hover popups) -->
  <div id="side-popup"></div>
  <div id="map"></div>
  <script>
    // Helper function: Convert a two-letter ISO country code into an emoji flag.
    function isoToEmoji(isoCode) {
      return isoCode
        .toUpperCase()
        .split('')
        .map(char => String.fromCodePoint(127397 + char.charCodeAt()))
        .join('');
    }
    
    // Function to update the side popup for country hover.
    // It uses only the ADMIN property (English name) and falls back to "Unknown" if not available.
    function updateCountrySidePopup(feature) {
      const countryName = feature.properties.ADMIN || feature.properties.NAME || feature.properties.name_en || "Unknown";
      const iso = (feature.properties.iso_3166_1 || "").toLowerCase();
      const emojiFlag = iso ? isoToEmoji(iso) : "";
      const content = `<div style="display:flex; align-items:center;">
                         <span style="font-size:32px; margin-right:10px;">${emojiFlag}</span>
                         <span style="font-size:20px; color:#0077ff;">${countryName}</span>
                       </div>`;
      const sidePopup = document.getElementById('side-popup');
      sidePopup.innerHTML = content;
      sidePopup.style.display = "block";
    }
    
    // Throttle function to limit execution frequency (used for country hover updates).
    function throttle(func, limit) {
      let lastFunc;
      let lastRan;
      return function() {
        const context = this;
        const args = arguments;
        if (!lastRan) {
          func.apply(context, args);
          lastRan = Date.now();
        } else {
          clearTimeout(lastFunc);
          lastFunc = setTimeout(function() {
            if ((Date.now() - lastRan) >= limit) {
              func.apply(context, args);
              lastRan = Date.now();
            }
          }, limit - (Date.now() - lastRan));
        }
      }
    }
    
    // Use your original Mapbox style and access token.
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2lja281IiwiYSI6ImNtNXNvNDlqcDBvcngyanE2OW9jYjEwYXMifQ.jCPdU-0lcRGjtDpaxoICsw';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/sicko5/cm6k1juil010301qm2krq7o84',
      center: [-30, 40], // roughly in the middle of the Atlantic
      zoom: 2
    });
    
    const mapMarkers = [];
    const cityMarkers = [];
    let lockedCity = null;
    // Flag to disable country hover effect when a country is clicked.
    let countryLocked = false;
    
    // Function to update the marker side popup.
    function updateSidePopup(data) {
      const sidePopup = document.getElementById('side-popup');
      if (data) {
        let content = "";
        if (!data.popup) {
          content += `<h3>${data.name}</h3>`;
        }
        content += data.popup ? `<div>${data.popup}</div>` : "";
        content += data.link ? `<a href="${data.link}" target="_blank">Explore →</a>` : "";
        sidePopup.innerHTML = content;
        sidePopup.style.display = "block";
      } else {
        sidePopup.style.display = "none";
      }
    }
    
    // Update marker visibility based on current zoom.
    function updateMarkerVisibility() {
      const zoom = map.getZoom();
      mapMarkers.forEach(marker => {
        const el = marker.getElement();
        const min = parseFloat(el.dataset.zoomMin);
        const max = parseFloat(el.dataset.zoomMax);
        el.style.display = (zoom >= min && zoom <= max) ? "block" : "none";
      });
    }
    
    // Load markers from CSV using PapaParse.
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vR-zg6jI431F1q5MKA927NjE5yZvZPLngBoyd0wmV93vyMSPOYsJMdSXJ1oWDkBZbiesDk6AlkUzR3M/pub?gid=0&single=true&output=csv", {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(markerData => {
          if (!markerData.lat || !markerData.lng) return;
          const el = document.createElement("div");
          el.className = "marker";
          const popupContent = `
            ${markerData.popup ? `<div>${markerData.popup}</div>` : `<h3>${markerData.name}</h3>`}
            ${markerData.link ? `<p style="margin-top:10px;"><a href="${markerData.link}" target="_blank" style="display:inline-block; padding:8px 14px; background:#0077ff; color:#fff; border-radius:6px; text-decoration:none; font-weight:bold;">Explore →</a></p>` : ""}
          `;
          const popup = new mapboxgl.Popup({ offset: 25, closeOnClick: false, closeButton: false })
            .setHTML(popupContent);
          const marker = new mapboxgl.Marker(el)
            .setLngLat([parseFloat(markerData.lng), parseFloat(markerData.lat)])
            .addTo(map);
          marker.markerData = markerData;
          if (markerData.isCity && markerData.isCity.toLowerCase() === "true") {
            cityMarkers.push(marker);
          }
          // Marker hover popup behavior.
          let isOverMarker = false;
          let isOverPopup = false;
          el.addEventListener("mouseenter", () => {
            countryLocked = false;
            isOverMarker = true;
            popup.setLngLat([parseFloat(markerData.lng), parseFloat(markerData.lat)]).addTo(map);
            popup.once("open", () => {
              const popupEl = popup.getElement();
              if (popupEl) {
                popupEl.addEventListener("mouseenter", () => { isOverPopup = true; });
                popupEl.addEventListener("mouseleave", () => {
                  isOverPopup = false;
                  if (!isOverMarker) popup.remove();
                });
              }
            });
          });
          el.addEventListener("mouseleave", () => {
            isOverMarker = false;
            setTimeout(() => {
              if (!isOverMarker && !isOverPopup) {
                popup.remove();
              }
            }, 100);
          });
          // On marker click: stop propagation, zoom in (to zoom 14, speed 1.5) and update side popup.
          el.addEventListener("click", (e) => {
            e.stopPropagation();
            countryLocked = false;
            updateSidePopup(null);
            if (markerData.isCity && markerData.isCity.toLowerCase() === "true") {
              map.flyTo({
                center: [parseFloat(markerData.lng), parseFloat(markerData.lat)],
                zoom: 14,
                speed: 1.5
              });
              lockedCity = markerData;
              updateSidePopup(markerData);
            } else {
              map.flyTo({
                center: [parseFloat(markerData.lng), parseFloat(markerData.lat)],
                zoom: 14,
                speed: 1.5
              });
              lockedCity = null;
              updateSidePopup(markerData);
            }
          });
          // Set zoom filtering: non-city markers default to min zoom 12.
          if (markerData.isCity && markerData.isCity.toLowerCase() === "true") {
            el.dataset.zoomMin = markerData.zoomMin || 0;
          } else {
            el.dataset.zoomMin = markerData.zoomMin || 12;
          }
          el.dataset.zoomMax = markerData.zoomMax || 20;
          el.dataset.name = (markerData.name || "").toLowerCase();
          mapMarkers.push(marker);
        });
        updateMarkerVisibility();
      }
    });
    
    map.on("zoom", updateMarkerVisibility);
    
    document.getElementById("search-box").addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();
      mapMarkers.forEach(marker => {
        const name = marker.getElement().dataset.name;
        marker.getElement().style.display = (!searchTerm || (name && name.includes(searchTerm))) ? "block" : "none";
      });
    });
    
    map.on("moveend", () => {
      const zoom = map.getZoom();
      if (zoom < 12) {
        updateSidePopup(null);
        lockedCity = null;
        return;
      }
      if (lockedCity) {
        updateSidePopup(lockedCity);
        return;
      }
      const canvasCenter = { x: map.getCanvas().width / 2, y: map.getCanvas().height / 2 };
      let closestCity = null;
      let minDist = Infinity;
      for (let i = 0; i < cityMarkers.length; i++) {
        const marker = cityMarkers[i];
        const screenPos = map.project(marker.getLngLat());
        const dx = screenPos.x - canvasCenter.x;
        const dy = screenPos.y - canvasCenter.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < minDist) {
          minDist = dist;
          closestCity = marker;
        }
      }
      if (closestCity && minDist < 100) {
        updateSidePopup(closestCity.markerData);
      } else {
        updateSidePopup(null);
      }
    });
    
    /* Add interactive country boundaries using fill layers.
       - Hover effect is enabled only when zoom is at or below a threshold:
         • For North America (ISO: USA, CAN, MEX), hover is enabled when zoom is ≤ 3.
         • For other regions, hover is enabled when zoom is ≤ 4.
       - Once a country is clicked, the hover effect is disabled via the countryLocked flag.
       - The mousemove event is throttled (20 ms) for performance.
       - On hover, the side popup displays the country’s English name (from ADMIN) and its emoji flag.
    */
    map.on("load", function() {
      map.addSource("country-boundaries", {
        type: "vector",
        url: "mapbox://mapbox.country-boundaries-v1"
      });
      // Fill layer for country areas (invisible but interactive).
      map.addLayer({
        id: "country-fills",
        type: "fill",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "fill-color": "#888888",
          "fill-opacity": 0
        }
      });
      // Fill layer for hover effect.
      map.addLayer({
        id: "country-fills-highlight",
        type: "fill",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "fill-color": "rgba(200,200,200,0.3)"
        },
        filter: ["==", "iso_3166_1", ""]
      });
      // Line layer for natural country borders.
      map.addLayer({
        id: "country-borders",
        type: "line",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "line-color": "#aaa",
          "line-width": 1
        }
      });
      
      // List of North American country ISO codes.
      const naCountries = ["USA", "CAN", "MEX"];
      
      // Throttled mousemove to update country hover highlight and side popup.
      map.on("mousemove", throttle(function(e) {
        // Determine threshold: for NA, disable hover if zoom > 3; for others, if zoom > 4.
        let threshold = 4; // default for non-NA.
        const features = map.queryRenderedFeatures(e.point, { layers: ["country-fills"] });
        if (features.length > 0) {
          const feature = features[0];
          if (naCountries.includes(feature.properties.iso_3166_1)) {
            threshold = 3;
          }
          if (map.getZoom() > threshold || countryLocked) {
            map.getCanvas().style.cursor = "";
            map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
            updateSidePopup(null);
            return;
          }
          map.getCanvas().style.cursor = "pointer";
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", feature.properties.iso_3166_1]);
          updateCountrySidePopup(feature);
        } else {
          map.getCanvas().style.cursor = "";
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
          updateSidePopup(null);
        }
      }, 20));
      
      // On click within a country, zoom to its mainland bounds and lock the hover effect.
      map.on("click", "country-fills", function(e) {
        if (e.features.length > 0) {
          const feature = e.features[0];
          let targetFeature = feature;
          if (feature.geometry.type === "MultiPolygon") {
            let maxArea = 0;
            feature.geometry.coordinates.forEach(polygon => {
              const polyFeature = {
                type: "Feature",
                geometry: {
                  type: "Polygon",
                  coordinates: polygon
                }
              };
              const area = turf.area(polyFeature);
              if (area > maxArea) {
                maxArea = area;
                targetFeature = polyFeature;
              }
            });
          }
          const bbox = turf.bbox(targetFeature);
          map.fitBounds(bbox, { padding: 20, duration: 500 });
          countryLocked = true;
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
          updateSidePopup(null);
        }
      });
    });
    
    // Reset countryLocked when clicking on empty space or a marker.
    map.on("click", function(e) {
      countryLocked = false;
    });
    
    // Ensure that map text and labels appear above the country hover layer.
    const layers = map.getStyle().layers;
    let firstSymbolId;
    for (let i = 0; i < layers.length; i++) {
      if (layers[i].type === "symbol") {
        firstSymbolId = layers[i].id;
        break;
      }
    }
    if (firstSymbolId) {
      map.moveLayer("country-fills-highlight", firstSymbolId);
    }
  </script>
</body>
</html>

