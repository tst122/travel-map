<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Interactive Map â€“ North America & Europe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Turf.js for spatial calculations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    /* Marker style with hover effect */
    .marker {
      background-color: #5a6bff;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
    }
    .marker:hover {
      background-color: #ff5722;
    }
    /* Popup content style */
    .mapboxgl-popup-content {
      padding: 15px;
      border-radius: 8px;
      background: #fff;
      color: #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border: 1px solid #eee;
      transition: all 0.2s ease;
    }
    .mapboxgl-popup-content h3 {
      margin: 0 0 5px;
      font-size: 18px;
      color: #0077ff;
    }
    .mapboxgl-popup-content p {
      margin: 0;
      font-size: 14px;
    }
    /* Search container style */
    #search-container {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(4px);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
    #search-box {
      width: 300px;
      padding: 10px;
      font-size: 16px;
      border: none;
      outline: none;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    /* Side popup style */
    #side-popup {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 250px;
      background: linear-gradient(145deg, #ffffff, #f9f9f9);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
      display: none;
      z-index: 11;
      border: 1px solid #ccc;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    #side-popup h3 {
      margin: 0 0 5px;
      color: #0077ff;
      font-size: 20px;
    }
    #side-popup a {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 14px;
      background: #0077ff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.2s;
    }
    #side-popup a:hover {
      background: #005bb5;
    }
  </style>
</head>
<body>
  <div id="search-container">
    <input type="text" id="search-box" placeholder="ðŸ” Search locations...">
  </div>
  <div id="side-popup"></div>
  <div id="map"></div>
  <script>
    // Throttle function (for country hover updates) with a limit of 10ms.
    function throttle(func, limit) {
      let lastFunc;
      let lastRan;
      return function() {
        const context = this;
        const args = arguments;
        if (!lastRan) {
          func.apply(context, args);
          lastRan = Date.now();
        } else {
          clearTimeout(lastFunc);
          lastFunc = setTimeout(function() {
            if ((Date.now() - lastRan) >= limit) {
              func.apply(context, args);
              lastRan = Date.now();
            }
          }, limit - (Date.now() - lastRan));
        }
      }
    }
    
    // Set map center so that North America and Europe are both visible.
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2lja281IiwiYSI6ImNtNXNvNDlqcDBvcngyanE2OW9jYjEwYXMifQ.jCPdU-0lcRGjtDpaxoICsw';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/sicko5/cm6k1juil010301qm2krq7o84',
      center: [-20, 55],
      zoom: 3.5
    });
    
    const mapMarkers = [];
    const cityMarkers = [];
    let lockedCity = null;
    let countryLocked = false; // When true, country hover is disabled.
    
    // Function to update side popup with marker data.
    function updateSidePopup(data) {
      const sidePopup = document.getElementById('side-popup');
      if (data) {
        let content = "";
        if (!data.popup) { content += `<h3>${data.name}</h3>`; }
        content += data.popup ? `<div>${data.popup}</div>` : "";
        content += data.link ? `<a href="${data.link}" target="_blank">Explore â†’</a>` : "";
        sidePopup.innerHTML = content;
        sidePopup.style.display = "block";
      } else {
        sidePopup.style.display = "none";
      }
    }
    
    // Update marker visibility based on zoom.
    function updateMarkerVisibility() {
      const zoom = map.getZoom();
      mapMarkers.forEach(marker => {
        const el = marker.getElement();
        const min = parseFloat(el.dataset.zoomMin);
        const max = parseFloat(el.dataset.zoomMax);
        el.style.display = (zoom >= min && zoom <= max) ? "block" : "none";
      });
    }
    
    // Load CSV markers.
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vR-zg6jI431F1q5MKA927NjE5yZvZPLngBoyd0wmV93vyMSPOYsJMdSXJ1oWDkBZbiesDk6AlkUzR3M/pub?gid=0&single=true&output=csv", {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(markerData => {
          if (!markerData.lat || !markerData.lng) return;
          const el = document.createElement("div");
          el.className = "marker";
          const popupContent = `
            ${markerData.popup ? `<div>${markerData.popup}</div>` : `<h3>${markerData.name}</h3>`}
            ${markerData.link ? `<p style="margin-top:10px;"><a href="${markerData.link}" target="_blank" style="display:inline-block; padding:8px 14px; background:#0077ff; color:#fff; border-radius:6px; text-decoration:none; font-weight:bold;">Explore â†’</a></p>` : ""}
          `;
          const popup = new mapboxgl.Popup({ offset: 25, closeOnClick: false, closeButton: false })
            .setHTML(popupContent);
          const marker = new mapboxgl.Marker(el)
            .setLngLat([parseFloat(markerData.lng), parseFloat(markerData.lat)])
            .addTo(map);
          marker.markerData = markerData;
          if (markerData.isCity && markerData.isCity.toLowerCase() === "true") {
            cityMarkers.push(marker);
          }
          // Instant hover popup behavior for markers.
          el.addEventListener("mouseenter", () => {
            countryLocked = false; // Reset country lock.
            el.style.opacity = "1";  // Ensure marker is fully visible.
            popup.setLngLat([parseFloat(markerData.lng), parseFloat(markerData.lat)]).addTo(map);
          });
          el.addEventListener("mouseleave", () => {
            // Remove popup without delay.
            popup.remove();
          });
          // On marker click: stop propagation, fly to marker, and update side popup.
          el.addEventListener("click", (e) => {
            e.stopPropagation();
            countryLocked = false;
            map.flyTo({
              center: [parseFloat(markerData.lng), parseFloat(markerData.lat)],
              zoom: 14,
              speed: 2
            });
            if (markerData.isCity && markerData.isCity.toLowerCase() === "true") {
              lockedCity = markerData;
            } else {
              lockedCity = null;
            }
            updateSidePopup(markerData);
          });
          // Set zoom filtering.
          if (markerData.isCity && markerData.isCity.toLowerCase() === "true") {
            el.dataset.zoomMin = markerData.zoomMin || 0;
          } else {
            el.dataset.zoomMin = markerData.zoomMin || 12;
          }
          el.dataset.zoomMax = markerData.zoomMax || 20;
          el.dataset.name = (markerData.name || "").toLowerCase();
          mapMarkers.push(marker);
        });
        updateMarkerVisibility();
      }
    });
    
    map.on("zoom", updateMarkerVisibility);
    
    document.getElementById("search-box").addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();
      mapMarkers.forEach(marker => {
        const name = marker.getElement().dataset.name;
        marker.getElement().style.display = (!searchTerm || (name && name.includes(searchTerm))) ? "block" : "none";
      });
    });
    
    map.on("moveend", () => {
      const zoom = map.getZoom();
      if (zoom < 12) {
        updateSidePopup(null);
        lockedCity = null;
        return;
      }
      if (lockedCity) {
        updateSidePopup(lockedCity);
        return;
      }
      const canvasCenter = { x: map.getCanvas().width / 2, y: map.getCanvas().height / 2 };
      let closestCity = null;
      let minDist = Infinity;
      for (let i = 0; i < cityMarkers.length; i++) {
        const marker = cityMarkers[i];
        const screenPos = map.project(marker.getLngLat());
        const dx = screenPos.x - canvasCenter.x;
        const dy = screenPos.y - canvasCenter.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < minDist) {
          minDist = dist;
          closestCity = marker;
        }
      }
      if (closestCity && minDist < 100) {
        updateSidePopup(closestCity.markerData);
      } else {
        updateSidePopup(null);
      }
    });
    
    /* Add interactive country boundaries using fill layers.
       - Hover effect is enabled when zoom is at or below:
         â€¢ For North America (ISO: USA, CAN, MEX): zoom â‰¤ 3.
         â€¢ For other regions: zoom â‰¤ 4.
       - Once a country is clicked, the hover effect is locked.
       - Mousemove is throttled (10 ms) for responsiveness.
       - The highlight layer is moved below symbol layers.
    */
    map.on("load", function() {
      map.addSource("country-boundaries", {
        type: "vector",
        url: "mapbox://mapbox.country-boundaries-v1"
      });
      // Invisible fill layer for interactivity.
      map.addLayer({
        id: "country-fills",
        type: "fill",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "fill-color": "#888888",
          "fill-opacity": 0
        }
      });
      // Highlight layer for hover.
      map.addLayer({
        id: "country-fills-highlight",
        type: "fill",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "fill-color": "rgba(200,200,200,0.3)"
        },
        filter: ["==", "iso_3166_1", ""]
      });
      // Line layer for natural borders.
      map.addLayer({
        id: "country-borders",
        type: "line",
        source: "country-boundaries",
        "source-layer": "country_boundaries",
        layout: {},
        paint: {
          "line-color": "#aaa",
          "line-width": 1
        }
      });
      
      // List of North American country ISO codes.
      const naCountries = ["USA", "CAN", "MEX"];
      
      // Throttled mousemove to update the highlight.
      map.on("mousemove", throttle(function(e) {
        // Set threshold: for NA, if zoom > 3 disable hover; for others, if zoom > 4 disable.
        let threshold = 4;
        const features = map.queryRenderedFeatures(e.point, { layers: ["country-fills"] });
        if (features.length > 0) {
          const feature = features[0];
          if (naCountries.includes(feature.properties.iso_3166_1)) {
            threshold = 3;
          }
          if (map.getZoom() > threshold || countryLocked) {
            map.getCanvas().style.cursor = "";
            map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
            return;
          }
          map.getCanvas().style.cursor = "pointer";
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", feature.properties.iso_3166_1]);
        } else {
          map.getCanvas().style.cursor = "";
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
        }
      }, 10));
      
      // On click within a country, zoom to its mainland bounds (largest polygon) quickly and lock hover.
      map.on("click", "country-fills", function(e) {
        if (e.features.length > 0) {
          const feature = e.features[0];
          let targetFeature = feature;
          if (feature.geometry.type === "MultiPolygon") {
            let maxArea = 0;
            feature.geometry.coordinates.forEach(polygon => {
              const polyFeature = {
                type: "Feature",
                geometry: {
                  type: "Polygon",
                  coordinates: polygon
                }
              };
              const area = turf.area(polyFeature);
              if (area > maxArea) {
                maxArea = area;
                targetFeature = polyFeature;
              }
            });
          }
          const bbox = turf.bbox(targetFeature);
          map.fitBounds(bbox, { padding: 20, duration: 300 });
          countryLocked = true;
          map.setFilter("country-fills-highlight", ["==", "iso_3166_1", ""]);
        }
      });
    });
    
    // Reset countryLocked when clicking on empty space.
    map.on("click", function(e) {
      countryLocked = false;
    });
    
    // Ensure country highlight layer is below symbol layers.
    map.on("styledata", function() {
      const layers = map.getStyle().layers;
      let firstSymbolId;
      for (let i = 0; i < layers.length; i++) {
        if (layers[i].type === "symbol") {
          firstSymbolId = layers[i].id;
          break;
        }
      }
      if (firstSymbolId) {
        map.moveLayer("country-fills-highlight", firstSymbolId);
      }
    });
  </script>
</body>
</html>
